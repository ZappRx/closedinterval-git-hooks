#!/bin/bash

# get hook name
GIT_HOOK=$(basename "$0")

# fix bug with cygwin 1.7.35
if [[ $(uname -s) == CYGWIN* ]] && [[ "$GIT_HOOK" == post-checkout-merge ]]; then
    if [[ $# -eq 3 ]]; then
        # post-checkout
        GIT_HOOK="post-checkout"
    elif [[ $# -eq 1 ]]; then
        # post merge
        GIT_HOOK="post-merge"
    fi
fi

if [[ "$GIT_HOOK" == "post-checkout" ]]; then
	PREV_REF=$1
	CURR_REF=$2
	if [[ $3 == 1 ]]; then
		FLAG_TYPE="branch"
	else
		FLAG_TYPE="file"
	fi
elif [[ "$GIT_HOOK" == "post-merge" ]]; then
	PREV_REF='HEAD@{1}'
	CURR_REF="HEAD"
	FLAG_TYPE="branch"
else
	echo "Unknown hook: $(basename $0)"
	exit 1
fi

# list changed files
FILES=$(git diff --name-only "$PREV_REF" "$CURR_REF")

# color flags
COLOR_BLUE="$(tput setaf 4)"
COLOR_CLEAR="$(tput sgr0)"

# don't bother when just checking out a file
if [[ "$FLAG_TYPE" == "branch" ]]; then
	# force windows style symlinks when possible
	if type symlink-reflow &> /dev/null && ! grep 'winsymlinks:native' <<< $CYGWIN &> /dev/null; then
		symlink-reflow -f .
	fi

	# update npm dependencies only if package.json has changed
	if ( type npm && echo "$FILES" | grep ^package.json ) &> /dev/null; then
		>&2 echo -e "${COLOR_BLUE}----- package.json changed updating npm -----${COLOR_CLEAR}"
		npm install --loglevel=error
		npm prune
	fi

	# update bower dependencies only if bower.json has changed
	if ( echo "$FILES" | grep ^bower.json ) &> /dev/null; then
		if type ./node_modules/.bin/bower &> /dev/null; then
			BOWER_BIN=./node_modules/.bin/bower
		elif type bower &> /dev/null; then
			BOWER_BIN=bower
		fi

		if [[ -n "$BOWER_BIN" ]]; then
			>&2 echo "${COLOR_BLUE}----- bower.json changed updating bower -----${COLOR_CLEAR}"
			"$BOWER_BIN" install --loglevel=error
			"$BOWER_BIN" prune
		fi
	fi
fi
